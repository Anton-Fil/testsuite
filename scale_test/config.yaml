---
metricsEndpoints: 
  - endpoint: {{ .PROMETHEUS_URL }}
    token: {{ .PROMETHEUS_TOKEN }}
    metrics: 
    - ./metrics.yaml
{{ if .OS_INDEXING }}
    indexer:
      type: opensearch
      esServers: ["{{ .ES_SERVER }}"]
      insecureSkipVerify: true
      defaultIndex: kube-burner
{{ else }}
    indexer:
      type: local
      metricsDirectory: ./metrics
{{ end }}
global: 
  gc: true
jobs: 
  - name: scale-test-preparations
    jobIterations: 1
    qps: 1
    burst: 1
    namespacedIterations: true
    namespace: scale-test
    waitWhenFinished: true
    objects:
      - objectTemplate: ./httpbin-deployment.yaml
        kind: Deployment
        replicas: 1
        waitOptions:
          forCondition: "Available"
          customStatusPath: ".conditions[].type"
      - objectTemplate: ./httpbin-service.yaml
        kind: Service
        replicas: 1
      - objectTemplate: ./aws-credentials.yaml
        kind: Secret
        replicas: 1
        inputVars:
          KUADRANT_AWS_ACCESS_KEY_ID: "{{ .KUADRANT_AWS_ACCESS_KEY_ID }}"
          KUADRANT_AWS_REGION: "{{ .KUADRANT_AWS_REGION }}"
          KUADRANT_AWS_SECRET_ACCESS_KEY: "{{ .KUADRANT_AWS_SECRET_ACCESS_KEY }}"
  - name: scale-test-main
    jobIterations: 1
    qps: 1
    burst: 1
    namespacedIterations: true
    namespace: scale-test
    waitWhenFinished: true
    objects:
      - objectTemplate: ./gw.yaml
        replicas: 1
        waitOptions:
          forCondition: Programmed
          customStatusPath: ".conditions[].type"
        inputVars:
          KUADRANT_ZONE_ROOT_DOMAIN: "{{ .KUADRANT_ZONE_ROOT_DOMAIN }}"
      - objectTemplate: ./gw-tls-policy.yaml
        replicas: 1
        waitOptions:
          forCondition: Enforced
          customStatusPath: ".conditions[].type"
      - objectTemplate: ./gw-dns-policy.yaml
        replicas: 1
        waitOptions:
          forCondition: Enforced
          customStatusPath: ".conditions[].type"
      - objectTemplate: ./gw-rlp.yaml
        replicas: 1
        waitOptions:
          forCondition: Accepted
          customStatusPath: ".conditions[].type"
      - objectTemplate: ./gw-auth-policy.yaml
        replicas: 1
        waitOptions:
          forCondition: Accepted
          customStatusPath: ".conditions[].type"
      - objectTemplate: ./httproute.yaml
        replicas: 1
        waitOptions:
          forCondition: Accepted
          customStatusPath: ".conditions[].type"
        inputVars:
          KUADRANT_ZONE_ROOT_DOMAIN: "{{ .KUADRANT_ZONE_ROOT_DOMAIN }}"
      - objectTemplate: ./httproute-rlp.yaml
        replicas: 1
        waitOptions:
          forCondition: Enforced
          customStatusPath: ".conditions[].type"
      - objectTemplate: ./httproute-auth-policy.yaml
        replicas: 1
        waitOptions:
          forCondition: Enforced
          customStatusPath: ".conditions[].type"
  - name: scale-test-safe-dnspolicy-cleanup
    jobType: delete
    jobIterations: 1
    namespacedIterations: true
    namespace: scale-test
    waitWhenFinished: true
    objects:
      - kind: DNSPolicy
        apiVersion: kuadrant.io/v1alpha1
        labelSelector: {kube-burner-job: scale-test-main}
